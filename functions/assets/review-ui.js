// Repo: gnr-blog-ai
// Path: functions/assets/review-ui.js

export async function onRequest(context) {
  const js = buildJs();
  return new Response(js, {
    status: 200,
    headers: {
      "content-type": "application/javascript; charset=utf-8",
      "cache-control": "no-store",
    },
  });
}

function buildJs() {
  // NOTE: keep this file plain JS (no smart quotes).
  return [
    "(function(){",
    "  function $(id){ return document.getElementById(id); }",
        " // Token comes from URL (CSP-safe). Fallback to body dataset if ever needed.",
        " var token = '';",
        " try {",
        "   token = (new URLSearchParams(location.search).get('t') || '').toString().trim();",
        " } catch (_) {",
        "   token = '';",
        " }",
        " if (!token) {",
        "   try { token = (document.body && document.body.dataset && document.body.dataset.reviewToken) ? String(document.body.dataset.reviewToken).trim() : ''; } catch (_) {}",
        " }",
        " if(!token){",
        "   console.error('Missing token (t) in URL');",
        "   // Keep UI alive but disable actions",
        "   var el = document.getElementById('statusText');",
        "   if (el) el.textContent = 'INVALID';",
        "   var meta = document.getElementById('statusMeta');",
        "   if (meta) meta.textContent = 'Missing token in URL';",
        "   return;",
        " }",
    "",
    "  var elStatusText = $('statusText');",
    "  var elStatusMeta = $('statusMeta');",
    "  var elStatusDot  = $('statusDot');",
    "  var elExpires    = $('expiresAt');",
    "  var elTitle      = $('pageTitle');",
    "  var elActionTitle= $('actionTitle');",
    "  var elActionHint = $('actionHint');",
    "  var toast        = $('toast');",
    "",
    "  var editToggleBtn= $('editToggleBtn');",
    "  var saveDraftBtn = $('saveDraftBtn');",
    "  var editorWrap   = $('editorWrap');",
    "  var draftText    = $('draftText');",
    "  var dirtyState   = $('dirtyState');",
    "",
    "  var followEmphasis = $('followEmphasis');",
    "  var followAvoid    = $('followAvoid');",
    "  var futureTopics   = $('futureTopics');",
    "  var saveTopicsBtn  = $('saveTopicsBtn');",
    "",
    "  var clientVisualKey = $('clientVisualKey');",
    "  var clientImageUrl  = $('clientImageUrl');",
    "  var clientSaveVisualBtn = $('clientSaveVisualBtn');",
    "  var clientPreviewVisualBtn = $('clientPreviewVisualBtn');",
    "  var clientImagePreview = $('clientImagePreview');",
    "  var clientImagePreviewEmpty = $('clientImagePreviewEmpty');",
    "",
    "  var acceptBtn = $('acceptBtn');",
    "  var jumpPreviewBtn = $('jumpPreviewBtn');",
    "  var jumpEditBtn = $('jumpEditBtn');",
    "",
    "  var modalBack = $('modalBack');",
    "  var modalCancelBtn = $('modalCancelBtn');",
    "  var modalConfirmBtn = $('modalConfirmBtn');",
    "",
    "  function showToast(message, kind){",
    "    var msg = String(message || '');",
    "    if(!toast){ try{ alert(msg); }catch(_){} return; }",
    "    var k = String(kind||'info');",
    "    var bg = (k==='error') ? 'rgba(239,68,68,.22)' : (k==='success') ? 'rgba(34,197,94,.18)' : 'rgba(0,0,0,.45)';",
    "    toast.style.background = bg;",
    "    toast.textContent = msg;",
    "    toast.style.display = 'block';",
    "    clearTimeout(showToast._t);",
    "    showToast._t = setTimeout(function(){ toast.style.display = 'none'; }, 4200);",
    "  }",
    "",
    "  function setStatus(status, meta){",
    "    var s = String(status||'').toUpperCase();",
    "    if(elStatusText) elStatusText.textContent = s || 'UNKNOWN';",
    "    if(elStatusMeta) elStatusMeta.textContent = String(meta||'');",
    "    if(elStatusDot){",
    "      var color = '#f59e0b';",
    "      var glow  = 'rgba(245,158,11,.18)';",
    "      if(s==='PENDING'){ color='#f59e0b'; glow='rgba(245,158,11,.18)'; }",
    "      else if(s==='ACCEPTED' || s==='APPROVED'){ color='#22c55e'; glow='rgba(34,197,94,.14)'; }",
    "      else if(s==='EXPIRED'){ color='#ef4444'; glow='rgba(239,68,68,.14)'; }",
    "      else if(s==='SUPERSEDED'){ color='#a1a1aa'; glow='rgba(161,161,170,.10)'; }",
    "      elStatusDot.style.background = color;",
    "      elStatusDot.style.boxShadow = '0 0 0 6px ' + glow;",
    "    }",
    "  }",
    "",
    "  function qs(sel){ return document.querySelector(sel); }",
    "  function jumpTo(selector){",
    "    try{",
    "      var el = qs(selector);",
    "      if(!el) return;",
    "      el.scrollIntoView({ behavior:'smooth', block:'start' });",
    "    }catch(_){}",
    "  }",
    "",
    "  // Step chips",
    "  document.addEventListener('click', function(ev){",
    "    var t = ev.target;",
    "    if(!t) return;",
    "    var chip = t.closest ? t.closest('[data-jump]') : null;",
    "    if(!chip) return;",
    "    var dest = chip.getAttribute('data-jump');",
    "    if(dest) jumpTo(dest);",
    "  });",
    "  if(jumpPreviewBtn) jumpPreviewBtn.addEventListener('click', function(){ jumpTo('#step1'); });",
    "  if(jumpEditBtn) jumpEditBtn.addEventListener('click', function(){ jumpTo('#step2'); });",
    "",
    "  function showModal(show){",
    "    if(!modalBack) return;",
    "    modalBack.style.display = show ? 'flex' : 'none';",
    "  }",
    "  if(modalCancelBtn) modalCancelBtn.addEventListener('click', function(){ showModal(false); });",
    "  if(modalBack) modalBack.addEventListener('click', function(ev){ if(ev.target === modalBack) showModal(false); });",
    "",
    "  async function readJson(res){",
    "    var txt = await res.text().catch(function(){ return ''; });",
    "    try{ return { ok: res.ok, status: res.status, json: txt ? JSON.parse(txt) : {} , raw: txt }; }",
    "    catch(e){ return { ok: res.ok, status: res.status, json: null, raw: txt }; }",
    "  }",
    "",
    "  function disableAll(){",
    "    var ids = ['acceptBtn','saveDraftBtn','editToggleBtn','saveTopicsBtn','clientSaveVisualBtn'];",
    "    ids.forEach(function(id){ var el=$(id); if(el) el.disabled = true; });",
    "  }",
    "",
    "  function setEditing(isEditing){",
    "    if(!editorWrap || !draftText || !editToggleBtn || !saveDraftBtn) return;",
    "    if(isEditing){",
    "      editorWrap.classList.remove('hide');",
    "      saveDraftBtn.classList.remove('hide');",
    "      editToggleBtn.textContent = 'Exit edit mode';",
    "      try{ draftText.focus(); }catch(_){}",
    "    } else {",
    "      editorWrap.classList.add('hide');",
    "      saveDraftBtn.classList.add('hide');",
    "      editToggleBtn.textContent = 'Enter edit mode';",
    "    }",
    "  }",
    "",
    "  // Dirty state + light autosave indicator (we only show; we do NOT autosave silently)",
    "  var dirty = false;",
    "  function setDirty(v){",
    "    dirty = !!v;",
    "    if(dirtyState){",
    "      dirtyState.textContent = dirty ? '• Unsaved changes' : '';",
    "    }",
    "  }",
    "",
    "  function showClientPreview(u){",
    "    var url = String(u||'').trim();",
    "    if(!clientImagePreview || !clientImagePreviewEmpty) return;",
    "    if(!url){",
    "      clientImagePreview.style.display = 'none';",
    "      clientImagePreviewEmpty.style.display = 'block';",
    "      clientImagePreviewEmpty.textContent = '(no preview yet)';",
    "      return;",
    "    }",
    "    clientImagePreview.src = url;",
    "    clientImagePreview.style.display = 'block';",
    "    clientImagePreviewEmpty.style.display = 'none';",
    "  }",
    "",
    "  async function boot(){",
    "    try{",
    "      setStatus('LOADING', 'Validating link…');",
    "      if(elActionTitle) elActionTitle.textContent = 'Validating secure link…';",
    "      if(elActionHint) elActionHint.textContent = 'Please wait';",
    "",
    "      var dbgRes = await fetch(location.origin + '/api/blog/review/debug?t=' + encodeURIComponent(token), { method:'GET', headers:{ 'Cache-Control':'no-cache' } });",
    "      var dbg = await readJson(dbgRes);",
    "      if(!dbg.ok){",
    "        disableAll();",
    "        setStatus('INVALID', 'Link could not be validated');",
    "        if(elActionTitle) elActionTitle.textContent = 'This link is not valid';",
    "        if(elActionHint) elActionHint.textContent = 'Please request a new review link';",
    "        showToast((dbg.json && (dbg.json.error||dbg.json.detail)) ? (dbg.json.error||dbg.json.detail) : ('Debug failed (HTTP '+dbg.status+')'), 'error');",
    "        return;",
    "      }",
    "",
    "      var row =",
    "        (dbg.json && dbg.json.review) ? dbg.json.review :",
    "        (dbg.json && dbg.json.row) ? dbg.json.row :",
    "        null;",
    "      ",
    "      var draft =",
    "        (dbg.json && dbg.json.draft) ? dbg.json.draft :",
    "        null;",
    "      var status =",
    "        (dbg.json && dbg.json.status) ? String(dbg.json.status).toUpperCase() :",
    "        (draft && draft.status) ? String(draft.status).toUpperCase() :",
    "        (row && row.status) ? String(row.status).toUpperCase() :",
    "        'UNKNOWN';",
    "      ",
    "      var expiresAt =",
    "        (row && row.expires_at) ? String(row.expires_at) :",
    "        '';",
    "      ",
    "      var draftId =",
    "        (dbg.json && dbg.json.draft_id) ? String(dbg.json.draft_id) :",
    "        (draft && draft.draft_id) ? String(draft.draft_id) :",
    "        (row && row.draft_id) ? String(row.draft_id) :",
    "        '';",
    "",
    "      setStatus(status, status === 'PENDING' ? 'Ready for your decision' : 'This link is not active');",
    "      if(elExpires) elExpires.textContent = expiresAt ? ('Expires: ' + expiresAt) : '';",
    "",
    "      // Load published preview HTML from the server-rendered draft view if available",
    "      // We prefer to reuse your existing renderer at /api/blog/draft/render/:id?view=generic",
    "      if(draftId){",
    "        var previewEl = document.getElementById('publishedPreview');",
    "        if(previewEl){",
    "      // Fetch HTML preview and import styles so it looks like the real article",
    "      try{",
    "        var renderUrl = location.origin + '/api/blog/draft/render/' + encodeURIComponent(draftId) + '?view=generic&embed=1';",
    "      ",
    "        // Wire the \"Open full preview\" button (new tab)",
    "        var openBtn = document.getElementById('openFullPreviewBtn');",
    "        if(openBtn){",
    "          openBtn.href = renderUrl.replace('&embed=1',''); // open the full page version",
    "        }",
    "      ",
    "        var pr = await fetch(renderUrl, { method:'GET', headers:{ 'Cache-Control':'no-cache' } });",
    "        var html = await pr.text();",
    "      ",
    "        if(pr.ok && html){",
    "          var bodyHtml = '';",
    "          var cssText = '';",
    "      ",
    "          // Prefer DOMParser so we can grab <style> from <head>",
    "          try{",
    "            if(typeof DOMParser !== 'undefined'){",
    "              var doc = new DOMParser().parseFromString(html, 'text/html');",
    "              if(doc){",
    "                // Collect ALL <style> blocks (head + body) so typography matches render output",
    "                var styles = doc.querySelectorAll('style');",
    "                if(styles && styles.length){",
    "                  for(var i=0;i<styles.length;i++){",
    "                    cssText += (styles[i].textContent || '') + '\n';",
    "                  }",
    "                }",
    "                bodyHtml = (doc.body && doc.body.innerHTML) ? doc.body.innerHTML : html;",
    "              } else {",
    "                bodyHtml = html;",
    "              }",
    "            } else {",
    "              bodyHtml = html;",
    "            }",
    "          }catch(_){",
    "            bodyHtml = html;",
    "          }",
    "      ",
    "          // Fallback: extract <body> if DOMParser failed",
    "          if(!bodyHtml){",
    "            var m = html.match(/<body[^>]*>([\\s\\S]*?)<\\/body>/i);",
    "            bodyHtml = m ? m[1] : html;",
    "          }",
    "      ",
    "          // Inject styles + wrap content so we control layout inside preview panel",
    "          var styleTag = cssText ? ('<style>' + cssText + '</style>') : '';",
    "          previewEl.innerHTML =",
    "            styleTag +",
    "            '<div class=\"gnr-render-root\">' +",
    "              bodyHtml +",
    "            '</div>';",
    "      ",
    "        } else {",
    "          previewEl.innerHTML = '<div style=\"padding:14px;border-radius:16px;border:1px dashed rgba(0,0,0,.18);background:#fff;\">Preview unavailable.</div>';",
    "        }",
    "      }catch(e){",
    "        previewEl.innerHTML = '<div style=\"padding:14px;border-radius:16px;border:1px dashed rgba(0,0,0,.18);background:#fff;\">Preview unavailable.</div>';",
    "      }",
    "        }",
    "      }",
    "",
    "      // Prefill guidance if present on review row",
    "      if(followEmphasis) followEmphasis.value = (row && row.follow_emphasis) ? String(row.follow_emphasis) : (followEmphasis.value||'');",
    "      if(followAvoid) followAvoid.value = (row && row.follow_avoid) ? String(row.follow_avoid) : (followAvoid.value||'');",
    "      if(futureTopics) futureTopics.value = (row && row.client_topic_suggestions) ? String(row.client_topic_suggestions) : (futureTopics.value||'');",
    "",
    "      // Lock UI for non-pending states",
    "      var isPending = (status === 'PENDING' || status === 'ISSUED');",
    "      if(!isPending){",
    "        disableAll();",
    "        if(elActionTitle) elActionTitle.textContent = 'This link is not active';",
    "        if(elActionHint) elActionHint.textContent = 'Status: ' + status;",
    "        showToast('This review link is not active (' + status + ').', 'info');",
    "      } else {",
    "        if(elActionTitle) elActionTitle.textContent = 'Ready when you are';",
    "        if(elActionHint) elActionHint.textContent = 'Preview → optional tweaks → accept';",
    "      }",
    "",
    "      // Edit mode wiring (only if pending)",
    "      var editing = false;",
    "      if(editToggleBtn){",
    "        editToggleBtn.addEventListener('click', function(){",
    "          if(!isPending){ showToast('Link not active ('+status+')', 'error'); return; }",
    "          editing = !editing;",
    "          setEditing(editing);",
    "          if(editing && draftText){",
    "            // Load draft markdown on demand via debug row (client_content_markdown not always present there).",
    "            // If your debug includes markdown later, we’ll prefill. For now, keep whatever is in textarea.",
    "            if(!draftText.value || draftText.value==='Loading draft…'){",
    "              draftText.value = '';",
    "              showToast('Paste/edit the draft markdown here, then Save changes.', 'info');",
    "            }",
    "          }",
    "        });",
    "      }",
    "",
    "      if(draftText){",
    "        draftText.addEventListener('input', function(){ setDirty(true); });",
    "      }",
    "",
    "      if(saveDraftBtn){",
    "        saveDraftBtn.addEventListener('click', async function(){",
    "          if(!isPending){ showToast('Link not active ('+status+')', 'error'); return; }",
    "          var md = String(draftText && draftText.value ? draftText.value : '').trim();",
    "          if(!md){ showToast('Nothing to save.', 'error'); return; }",
    "          saveDraftBtn.disabled = true;",
    "          try{",
    "            var res = await fetch(location.origin + '/api/blog/review/save', {",
    "              method:'POST',",
    "              headers:{ 'Content-Type':'application/json', 'Cache-Control':'no-cache' },",
    "              body: JSON.stringify({ t: token, content_markdown: md, follow_emphasis: (followEmphasis?followEmphasis.value:''), follow_avoid: (followAvoid?followAvoid.value:'') })",
    "            });",
    "            var parsed = await readJson(res);",
    "            if(!parsed.ok){",
    "              showToast((parsed.json && (parsed.json.error||parsed.json.detail)) ? (parsed.json.error||parsed.json.detail) : ('Save failed (HTTP '+parsed.status+')'), 'error');",
    "              return;",
    "            }",
    "            setDirty(false);",
    "            showToast('Saved. Reloading preview…', 'success');",
    "            setTimeout(function(){ location.reload(); }, 350);",
    "          } finally {",
    "            saveDraftBtn.disabled = false;",
    "          }",
    "        });",
    "      }",
    "",
    "      if(clientPreviewVisualBtn){",
    "        clientPreviewVisualBtn.addEventListener('click', function(e){",
    "          try{ e.preventDefault(); }catch(_){}",
    "          showClientPreview(clientImageUrl && clientImageUrl.value ? clientImageUrl.value : '');",
    "          showToast('Preview updated.', 'info');",
    "        });",
    "      }",
    "",
    "      if(clientSaveVisualBtn){",
    "        clientSaveVisualBtn.addEventListener('click', async function(e){",
    "          try{ e.preventDefault(); }catch(_){}",
    "          if(!isPending){ showToast('Link not active ('+status+')', 'error'); return; }",
    "          var vk = String(clientVisualKey && clientVisualKey.value ? clientVisualKey.value : '').trim();",
    "          var u  = String(clientImageUrl && clientImageUrl.value ? clientImageUrl.value : '').trim();",
    "          if(!vk){ showToast('Choose an image slot first.', 'error'); return; }",
    "          if(!u){ showToast('Paste an image URL first.', 'error'); return; }",
    "          if(!/^https:\\/\\//i.test(u)){ showToast('Image URL must start with https://', 'error'); return; }",
    "          clientSaveVisualBtn.disabled = true;",
    "          try{",
    "            var res = await fetch(location.origin + '/api/blog/review/visuals/save', {",
    "              method:'POST',",
    "              headers:{ 'Content-Type':'application/json', 'Cache-Control':'no-cache' },",
    "              body: JSON.stringify({ t: token, visual_key: vk, image_url: u })",
    "            });",
    "            var parsed = await readJson(res);",
    "            if(!parsed.ok){",
    "              showToast((parsed.json && (parsed.json.error||parsed.json.detail)) ? (parsed.json.error||parsed.json.detail) : ('Save failed (HTTP '+parsed.status+')'), 'error');",
    "              return;",
    "            }",
    "            showToast('Image saved. Reloading…', 'success');",
    "            setTimeout(function(){ location.reload(); }, 450);",
    "          } finally {",
    "            clientSaveVisualBtn.disabled = false;",
    "          }",
    "        });",
    "      }",
    "",
    "      if(saveTopicsBtn){",
    "        saveTopicsBtn.addEventListener('click', async function(){",
    "          if(!isPending){ showToast('Link not active ('+status+')', 'error'); return; }",
    "          var payload = {",
    "            t: token,",
    "            suggestions: String(futureTopics && futureTopics.value ? futureTopics.value : '').trim(),",
    "            follow_emphasis: String(followEmphasis && followEmphasis.value ? followEmphasis.value : '').trim(),",
    "            follow_avoid: String(followAvoid && followAvoid.value ? followAvoid.value : '').trim()",
    "          };",
    "          // Allow blank saves only if field keys exist; we always send keys here, so OK.",
    "          saveTopicsBtn.disabled = true;",
    "          try{",
    "            var res = await fetch(location.origin + '/api/blog/review/suggestions/save', {",
    "              method:'POST',",
    "              headers:{ 'Content-Type':'application/json', 'Cache-Control':'no-cache' },",
    "              body: JSON.stringify(payload)",
    "            });",
    "            var parsed = await readJson(res);",
    "            if(!parsed.ok){",
    "              showToast((parsed.json && (parsed.json.error||parsed.json.detail)) ? (parsed.json.error||parsed.json.detail) : ('Save failed (HTTP '+parsed.status+')'), 'error');",
    "              return;",
    "            }",
    "            showToast('Saved for future articles.', 'success');",
    "          } finally {",
    "            saveTopicsBtn.disabled = false;",
    "          }",
    "        });",
    "      }",
    "",
    "      if(acceptBtn){",
    "        acceptBtn.addEventListener('click', function(){",
    "          if(!isPending){ showToast('Link not active ('+status+')', 'error'); return; }",
    "          showModal(true);",
    "        });",
    "      }",
    "",
    "      if(modalConfirmBtn){",
    "        modalConfirmBtn.addEventListener('click', async function(){",
    "          if(!isPending){ showToast('Link not active ('+status+')', 'error'); showModal(false); return; }",
    "          modalConfirmBtn.disabled = true;",
    "          try{",
    "            var res = await fetch(location.origin + '/api/blog/review/accept', {",
    "              method:'POST',",
    "              headers:{ 'Content-Type':'application/json', 'Cache-Control':'no-cache' },",
    "              body: JSON.stringify({ t: token, follow_emphasis: (followEmphasis?followEmphasis.value:''), follow_avoid: (followAvoid?followAvoid.value:'') })",
    "            });",
    "            var parsed = await readJson(res);",
    "            if(!parsed.ok){",
    "              showToast((parsed.json && (parsed.json.error||parsed.json.detail)) ? (parsed.json.error||parsed.json.detail) : ('Accept failed (HTTP '+parsed.status+')'), 'error');",
    "              return;",
    "            }",
    "            showToast('Accepted. Finalising…', 'success');",
    "            showModal(false);",
    "            setTimeout(function(){ location.reload(); }, 650);",
    "          } finally {",
    "            modalConfirmBtn.disabled = false;",
    "          }",
    "        });",
    "      }",
    "",
    "      // Keyboard shortcuts",
    "      document.addEventListener('keydown', function(ev){",
    "        if(!ev) return;",
    "        // Cmd/Ctrl+Enter = accept",
    "        if((ev.metaKey || ev.ctrlKey) && ev.key === 'Enter'){",
    "          if(acceptBtn && !acceptBtn.disabled){",
    "            ev.preventDefault();",
    "            showModal(true);",
    "          }",
    "        }",
    "        // Esc closes modal",
    "        if(ev.key === 'Escape'){",
    "          if(modalBack && modalBack.style.display === 'flex'){ showModal(false); }",
    "        }",
    "      });",
    "",
    "    } catch(e){",
    "      console.error('REVIEW_UI_FATAL', e);",
    "      showToast('UI crashed: ' + String(e && e.message ? e.message : e), 'error');",
    "      disableAll();",
    "    }",
    "  }",
    "",
    "  if(document.readyState === 'loading'){",
    "    document.addEventListener('DOMContentLoaded', boot);",
    "  } else {",
    "    boot();",
    "  }",
    "})();",
  ].join("\n");
}
